<template>
<<<<<<< mine
    <div id="clients-add-form-container">
        <a href="#" class="btn-green" @click.prevent="openPopup"><img src="/images/add-client.png" alt=""> Add Clients</a>
=======
    <div id="students-list-container">
        <div>
            <span class="btn btn-green" @click="openPopup"><img src="../../images/add-user.png" alt=""> Add Clients</span>
        </div>
>>>>>>> theirs

        <magnific-popup-modal :show="false" :config="{closeOnBgClick:false,showCloseBtn:false,enableEscapeKey:false}" ref="modal">
            <div style="background: white;width:700px;padding:0.25em 1em;">

                <input v-model="searchString" placeholder="Search by name , instagram, email or phone"/>

                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col">Instagram</th>
                            <th scope="col">Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(student, index) in listItems">
                            <td>

                                <input type="checkbox" v-model="selectedStudents" :value="student.id"/>
                            </td>
                            <td><img :src="student.profile.image"/></td>
                            <td><a :href="'https://www.instagram.com/' + student.profile.instagram_handle" target="_blank">{{ student.profile.instagram_handle }}</a></td>
                            <td>{{ student.full_name }}</td>
                            <td>{{ student.email }}</td>
                            <td>{{ student.profile.mobile_phone }}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="row">
                    <div class="col-xs-4">
                        <span @click="addClients" class="btn btn-default">Add {{ selectedStudents.length }} clients</span>
                    </div>
                    <div class="col-xs-4">
                        <span class="btn btn-danger" @click="clearFormAndClosePopup">Close Form</span>
                    </div>
                </div>

                <div v-if="errorText" class="has-error">{{ errorText }}</div>
                <div v-if="successText" class="has-success">{{ successText }}</div>
            </div>
        </magnific-popup-modal>
    </div>
</template>

<script>
	import siteAPI from '../mixins/siteAPI.js';
	import skillectiveHelper from '../mixins/skillectiveHelper.js';
	import MagnificPopupModal from './external/MagnificPopupModal'

	export default {
		mixins : [siteAPI, skillectiveHelper],
		data() {
			return {
				selectedStudents: [],
                searchString : ''
			}
		},
		components: {
			MagnificPopupModal
		},
		methods: {
			getStudents() {
				let queryParams = {};
                queryParams.s = this.searchString;

				this.apiGet('/api/students', {
					params: queryParams
				});
			},
			componentHandleGetResponse(responseData) {
				this.listItems = responseData.data.data;
			},
			addClients() {
                this.apiPost('/api/instructor/clients', {students : this.selectedStudents});
			},
			componentHandlePostResponse(responseData) {
				this.clearFormAndClosePopup();
				this.$root.$emit('instructorClientsAdded');
			},
			openPopup(){
				this.$refs.modal.open();
				this.getStudents();
			},
			clearFormAndClosePopup(){
				this.selectedStudents = [];
				this.searchString = null;
				this.successText = null;
				this.$refs.modal.close()
			}
		},
        created : function(){
			this.debouncedGetStudents = _.debounce(this.getStudents, 500)
        },
		watch: {
			searchString : function (newSearchString, oldSearchString) {
				if (newSearchString!==null)
				    this.debouncedGetStudents();
			}
		}
	}
</script>